<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Blog Article Copenhagen</title>
    <meta name="description" content="Blog Article Copenhagen">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
<div class="autoreload">
    <label for="autoreload">
        <input type="checkbox" id="autoreload">
        auto reload
    </label>
</div>

<!-- ARTICLE START -->

<p>
    Hi, I'm Patrick, software engineer at mobile.de. My team and I work for <a href="http://www.mobile.de">mobile.de</a>, which is Germany's biggest online marketplace for cars and other vehicles.
</p>
<p>
    In June 2015, we were given a task that every software developer dreams of: throw away all the old stuff and rewrite everything from scratch. The “old stuff” being the public German home page of mobile.de, the main entry point of our platform.
</p>

<h3>mobile.de before...</h3>
<p>
    <a href="./data/mediapool/mobile.de-before-relaunch_825x710.png" target="_blank"><img src="./data/mediapool/mobile.de-before-relaunch_557x478.png" alt="mobile.de before the relaunch" width="557" height="478"></a>
</p>

<h3>...and after the relaunch</h3>
<p>
    <a href="./data/mediapool/mobile.de-after-relaunch_1013x755.png" target="_blank"><img src="./data/mediapool/mobile.de-after-relaunch_700x522.png" alt="mobile.de after the relaunch" width="700" height="522"></a>
</p>

<h2>Why Node.js?</h2>

<p>We have, traditionally been a Java shop since we migrated from a big steaming pile of Perl back in 2007, but engineers at mobile.de are encouraged to explore new technologies and empowered to choose the best tool for the task at hand.</p>

<p>It was not hard to convince the Powers That Be<sup>TM</sup> that we should go for <a href="https://nodejs.org/">Node.js</a>, although it was still fairly new technology for us.</p>

<p>At the time we started planning our team included four JavaScript experts (including myself) and two Java experts.</p>

<p>Our system architecture has evolved from monilithic to service-oriented in the last year or so. The new home page was to become a pretty simple web application, a thin layer between a handful of service APIs and the client-side code. Node.js is really good at integrating services and passing data through to the presentation layer, so it was an obvious choice.</p>

<figure>
    <img src="./data/mediapool/plan-h-architecture_573x517.png" alt="A thin layer" width="573" height="517">
    <figcaption>A thin layer between services and client</figcaption>
</figure>

<h2>Our Build System</h2>

<div class="placeholder">
    npm
    Gulp
    webpack
</div>

<p>For further reading on why webpack is awesome, check out <a href="http://www.technology-ebay.de/the-teams/mobile-de/blog/packing-the-web-like-a-boss.html">this blog article</a> that I wrote on the subject.</p>

<h3>Example: mobile.de Boilerplate</h3>

<div class="placeholder">
    maybe do a screen recording of live editing
    put a skeleton version of CPH build system in public GitHub
</div>

<h2>ECMAScript 2015</h2>

<div class="placeholder">Babel, frontend and backend</div>

<h3>Example: Promise-driven Service Integration</h3>

<p>As I've mentioned before, the Copenhagen web app is basically a backend layer between the client and a handful of microservices. How to go about integrating those services? The requests to the services happen asynchronously, which is always fun to implement and the default way Node.js handles things.</p>

<p>For example, we have an advertising service that gives us all the code snippets to be integrated on the page, that display all those colorful ads that our users love so much &#128522;</p>

<figure>
    <img src="./data/mediapool/advertising-service_700x422.png" alt="Advertising service" width="700" height="422">
    <figcaption>Advertising service</figcaption>
</figure>

<p>I don't have to explain about <a href="http://callbackhell.com/">callback hell</a>, the dreaded tangle of nested callback functions. There are much better ways to handle asynchronous calls, and ES6 comes with two of them built in, namely <a href="https://developer.mozilla.org/de/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promises</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Generator">Generators</a>. I have to admit it, I have not yet quite wrapped my head around Generators, despite reading excellent articles about it like the one by <a href="http://davidwalsh.name/es6-generators">Kyle Simpson</a>.</p>

<p>Promises are easier to grasp: you create a Promise that is resolved or rejected after the async magic has happened (in this case, after JSON data has been loaded from the advertising service – or not). Then you create a chain of things that happen afterwards, using the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/JavaScript_code_modules/Promise.jsm/Promise#then%28%29">then method</a>. To handle errors, you add a <a href="https://developer.mozilla.org/en-US/docs/Mozilla/JavaScript_code_modules/Promise.jsm/Promise#catch%28%29">catch method</a> to the chain.

<p>Our controller code that uses a client component for accessing the advertising service looks like this:</p>

<iframe src="http://pahund.github.io/blog-article-copenhagen/code-example-axios-controller.html" frameBorder="0"  width="100%" height="490" scrolling="no" seamless></iframe>

<p>As you can see, with promises, it's possible to create a chain of <em>then</em> methods to control the flow of asynchronous code execution. The best part is the possibility to use <em>catch</em> to handle errors that occur at any point in the chain.</p>

<h3>Oh, noes!</h3>

<p>To send the actual request to the server, the <em>Advertising</em> instance uses <a href="https://github.com/mzabriskie/axios">Axios</a>, a promise-based HTTP client by Matt Zabriskie, which I found quite charming at the time.</p>

<p>Alas, when it was time to integrate another service that channels traffic between the desktop site and the mobile-optimized site, we hit a road block. Our channeling service expected the user agent header of the API request to be the one of the browser accessing the frontend, but Axios always sets the UA to its own, special user agent string.</p>

<p>It's a known issue that <a href="https://github.com/mzabriskie/axios/issues/69">other developers have also come accross</a>. The author of Axios fixed it, but he hadn't released a new npm module version with the fix until after the launch of our project. So we were stuck with a <em>package.json</em> file that has an entry like this:</p>

<iframe src="http://pahund.github.io/blog-article-copenhagen/code-example-axios-package-json.html" frameBorder="0"  width="100%" height="100"></iframe>

<h2>Dust Templates</h2>

<div class="placeholder">
    about Dust
</div>

<h3>Example: Inlining JavaScript with a Dust Helper</h3>

<div class="placeholder">
    billboard.dust
    inline.js
</div>

<h2>Reusable Layout Components</h2>

<div class="placeholder">
    “Twitter Bootstrap for mobile.de”
    Living style guide
    some explanation about Bower
    OpenSource-like ecosystem inside our company
    note about OpenSource – we plan to publish OOS soon
</div>

<h2>Express Framework</h2>

<div class="placeholder">
    MVC architecture
    names of controllers, models and views corresponding
</div>

<h3>Example: Channeling Middleware</h3>

<div class="placeholder">
    canneling.js
</div>

<h2>Automated Tests</h2>

<div class="placeholder">
    Robot
    Mocha, Chai and Sinon
    Problems
        Freshy
        Toboggan
        Async
        Architecture
</div>

<h3>Test Coverage</h3>

<div class="placeholder">
    98% - yay!
    pic
</div>

<h3>Example: JS Unit Test With Mocha, Chai and Sinon</h3>

<div class="placeholder">
    firstRegOptions-test.js
</div>

<h2>Monitoring and Logging</h2>
<p>
    We have roughly 7.29 unique users per month<sup>1</sup>, so the website gets a lot of traffic (about 40 requests per second). If we screw up, there's thousands people left out in the cold. So it's essential the the servers run smoothly – and if things do go south, there must be proper monitoring in place that immediately alerts us and proper logging to quickly help us find out what went wrong. My colleague <a href="http://twitter.com/https://twitter.com/jonykrause">Jonathan Krause</a> will go into detail on this in another blog article coming soon to this station – stay tuned!
</p>

<h2>Hard Learned Lessons</h2>

<img src="./data/mediapool/cross-stitch-npm-modules_700x326.png" alt="Be careful which npm modules you choose" width="700" height="326">

<div class="placeholder"></div>

<img src="./data/mediapool/cross-stitch-early-prod_700x334.png" alt="Run your app in production as early as possible" width="700" height="334">

<div class="placeholder"></div>

<img src="./data/mediapool/cross-stitch-pairing_700x285.png" alt="Code reviews are silver, pair programming is gold" width="700" height="285">

<div class="placeholder"></div>

<img src="./data/mediapool/cross-stitch-simple_700x341.png" alt="Keep it simple" width="700" height="341">

<div class="placeholder"></div>

<h2>Acknowledgements</h2>
<ul>
    <li><a href="https://en.wikipedia.org/wiki/Food_photography#/media/File:Ice_cubes_openphoto.jpg">Ice Cubes</a> photograph by Darren Hester</li>
    <li>Cross stitch headlines made with <a href="https://photofunia.com/">Photofunia</a></li>
</ul>
<h2>Footnotes</h2>
<p>
    <sup>1</sup> AGOF internet facts 05-2015
</p>

<!-- ARTICLE END -->

<script src="js/main.js"></script>
</body>
</html>
